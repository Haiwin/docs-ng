<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE topic
  PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
<topic xml:lang="en-us" id="topic5938"><title>Rebalancing nodes</title><body><p>To start a rebalance process through the REST API you must supply two arguments
containing the list of nodes that have been marked to be ejected, and the list
of nodes that are known within the cluster. </p><section><title>Initiating a rebalance</title><p>You can obtain the information about ejected and known node by
getting the current node configuration from <xref href="#topic5938/couchbase-admin-restapi-node-management">Managing Couchbase
Nodes</xref>. This is to ensure that the
client making the REST API request is aware of the current cluster
configuration. Nodes should have been previously added or marked for removal as
appropriate.</p><p>The information must be supplied via the <codeph>ejectedNodes</codeph> and <codeph>knownNodes</codeph>
parameters as a <codeph>POST</codeph> operation to the <codeph>/controller/rebalance</codeph> endpoint. </p><p><b>Example</b></p><codeblock><codeph>curl -v -X -u admin:password POST 'http://192.168.0.77:8091/controller/rebalance' \
-d 'ejectedNodes=&amp;knownNodes=ns_1%40192.168.0.77%2Cns_1%40192.168.0.56'
</codeph></codeblock><p>Replace the <i>admin</i>, <i>password</i>, <i>192.168.0.77</i>, and <i>192.168.0.56</i>
values in the above example with your actual values.</p><p>The corresponding raw HTTP request:</p><codeblock><codeph>POST /controller/rebalance HTTP/1.1
Authorization: Basic QWRtaW5pc3RyYXRvcjpUYW1zaW4=
User-Agent: curl/7.24.0 (x86_64-apple-darwin12.0) libcurl/7.24.0 OpenSSL/0.9.8r zlib/1.2.5
Host: 192.168.0.77:8091
Accept: */*
Content-Length: 63
Content-Type: application/x-www-form-urlencoded
</codeph></codeblock><p>The response will be 200 (OK) if the operation was successfully submitted.</p><p>If the wrong node information has been submitted, JSON with the mismatch error
will be returned:</p><codeblock><codeph>{"mismatch":1}
</codeph></codeblock><p>Progress of the rebalance operation can be obtained by using <xref href="#topic5938/couchbase-admin-restapi-rebalance-progress">Getting Rebalance
Progress</xref>.</p><p><!--Removed anchor point couchbase-admin-restapi-rebalance-progress--></p></section><section><title>Getting rebalance progress</title><p>There are two endpoints for rebalance progress. One is a general request which
outputs high-level percentage completion at <codeph>/pools/default/rebalanceProgress</codeph>.
The second possible endpoint is one corresponds to the detailed rebalance report
available in Web Console, see <xref href="../cb-admin/#couchbase-admin-tasks-addremove-rebalance-monitoring" format="html">Monitoring a
Rebalance</xref> for details
and definitions.</p><p><b>Example</b></p><p>This first request returns a JSON structure containing the current progress
information:</p><codeblock><codeph>curl -u admin:password '192.168.0.77:8091/pools/default/rebalanceProgress'
</codeph></codeblock><p>Replace the <i>admin</i>, <i>password</i>, <i>localhost</i>, and <i>192.168.0.77</i>
values in the above example with your actual values.</p><p>As a pure REST API call, it appears as follows:</p><codeblock><codeph>GET /pools/default/rebalanceProgress HTTP/1.1
Authorization: Basic QWRtaW5pc3RyYXRvcjpUYW1zaW4=
User-Agent: curl/7.24.0 (x86_64-apple-darwin12.0) libcurl/7.24.0 OpenSSL/0.9.8r zlib/1.2.5
Host: 192.168.0.77:8091
Accept: */*
</codeph></codeblock><p>The response data packet contains a JSON structure showing the rebalance
progress for each node. The progress figure is provided as a percentage (shown
as a floating point value between 0 and 1).</p><codeblock><codeph>{
    "status":"running",
    "ns_1@192.168.0.56":{"progress":0.2734375},
    "ns_1@192.168.0.77":{"progress":0.09114583333333337}
}
</codeph></codeblock><p>For more details about the rebalance, use the following request:</p><codeblock><codeph>curl -u admin:password 'http://localhost:8091/pools/default/tasks'
</codeph></codeblock><p>Replace the <i>admin</i>, <i>password</i>, and <i>localhost</i> values in the above example
with your actual values.</p><codeblock><codeph>GET /pools/default/rebalanceProgress HTTP/1.1
Authorization: Basic QWRtaW5pc3RyYXRvcjpUYW1zaW4=
User-Agent: curl/7.24.0 (x86_64-apple-darwin12.0) libcurl/7.24.0 OpenSSL/0.9.8r zlib/1.2.5
Host: 192.168.0.77:8091
Accept: */*
</codeph></codeblock><p>The response data packet contains a JSON structure showing detailed progress:</p><codeblock><codeph>
{
  type: "rebalance",
  recommendedRefreshPeriod: 0.25,
  status: "running",
  progress: 9.049479166666668,
  perNode: {
    ns_1@10.3.3.61: {
      progress: 13.4765625
    },
    ns_1@10.3.2.55: {
      progress: 4.6223958333333375
    }
  },
  detailedProgress: {
    bucket: "default",
    bucketNumber: 1,
    bucketsCount: 1,
    perNode: {
      ns_1@10.3.3.61: {
        ingoing: {
          docsTotal: 0,
          docsTransferred: 0,
          activeVBucketsLeft: 0,
          replicaVBucketsLeft: 0
        },
        outgoing: {
          docsTotal: 512,
          docsTransferred: 69,
          activeVBucketsLeft: 443,
          replicaVBucketsLeft: 511
        }
      },
      ns_1@10.3.2.55: {
        ingoing: {
          docsTotal: 512,
          docsTransferred: 69,
          activeVBucketsLeft: 443,
          replicaVBucketsLeft: 0
        },
        outgoing: {
          docsTotal: 0,
          docsTransferred: 0,
          activeVBucketsLeft: 0,
          replicaVBucketsLeft: 443
        }
      }
    }
  }
}
</codeph></codeblock><p>This shows percentage complete for each individual node undergoing
rebalance. For each specific node, it provides the current number of docs
transferred and other items. For details and definitions of these items, see
<xref href="../cb-admin/#couchbase-admin-tasks-addremove-rebalance-monitoring" format="html">Monitoring a Rebalance</xref>.</p><p>If you rebalance fails, you will see this response:</p><codeblock><codeph>[
  {
    "type": "rebalance",
    "status": "notRunning",
    "errorMessage": "Rebalance failed. See logs for detailed reason. You can try rebalance again."
  }
]
</codeph></codeblock><p><!--Removed anchor point couchbase-admin-restapi-rebalance-before-compaction--></p></section><section><title>Adjusting rebalance during compaction</title><p>If you perform a rebalance while a node is undergoing index compaction, you may
experience delays in rebalance. There is REST API parameter as of Couchbase
Server 2.0.1 you can use to improve rebalance performance. If you do make this
selection, you will reduce the performance of index compaction which can result
in larger index file size.</p><p><b>Example</b></p><p>To make this request:</p><codeblock><codeph>curl -X POST -u admin:password 'http://localhost:8091/internalSettings' 
    -d 'rebalanceMovesBeforeCompaction=256'
</codeph></codeblock><p>Replace the <i>admin</i>, <i>password</i>, <i>localhost</i>, and <i>256</i> values in the above
example with your actual values.</p><p>This needs to be made as POST request to the <codeph>/internalSettings</codeph> endpoint. By
default this setting is 16, which specifies the number of vBuckets which will
moved per node until all vBucket movements pauses. After this pause the system
triggers index compaction. Index compaction will not be performed while vBuckets
are being moved, so if you specify a larger value, it means that the server will
spend less time compacting the index, which will result in larger index files
that take up more disk space.</p></section></body><related-links><linklist><title>Collected links</title><link href="../cb-admin/#couchbase-admin-tasks-addremove-rebalance-monitoring" format="html"><linktext>Monitoring a
Rebalance</linktext></link><link href="../cb-admin/#couchbase-admin-tasks-addremove-rebalance-monitoring" format="html"><linktext>Monitoring a Rebalance</linktext></link></linklist></related-links></topic>